<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duckcord</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByn0r_mDko9LlZh9NC_x5KZjqA4eTu8eo",
            authDomain: "budgetdiscord-375a7.firebaseapp.com",
            databaseURL: "https://budgetdiscord-375a7-default-rtdb.firebaseio.com/",
            projectId: "budgetdiscord-375a7",
            storageBucket: "budgetdiscord-375a7.appspot.com",
            messagingSenderId: "696511526534",
            appId: "1:696511526534:web:8753b864c85bb583cf4307",
            measurementId: "G-Z7HJZTRPZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        function writeUserData(message, name, uid) {
            set(ref(db, "messages/" + Date.now()), {
                username: name,
                uid: uid,
                message: message
            }).then(() => {
                console.log("Message saved.");
            }).catch((error) => {
                console.error("Error writing data:", error);
            });
        }

        function getFirstName(fullName) {
            const names = fullName.split(" ");
            return names[0];
        }

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../signin";
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const messagesContainer = document.getElementById("messages-container");
            let lastMessageTime = 0; // Track the last message timestamp

            document.getElementById("message-input").addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById("send-button").click();
                }
            });

            document.getElementById("send-button").addEventListener("click", () => {
                const user = auth.currentUser;
                if (!user) return;

                const now = Date.now();
                if (now - lastMessageTime < 1000) {
                    console.log("You must wait before sending another message.");
                    return;
                }

                const message = document.getElementById("message-input").value.trim();
                if (message) {
                    writeUserData(message, getFirstName(user.displayName), user.uid);
                    document.getElementById("message-input").value = "";
                    lastMessageTime = now; // Update the last message timestamp
                }

                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            });
        });
    </script>
    <link rel="stylesheet" href="../style.css">
</head>

<body>
    <div id="main">
        <h2>Duckcord</h2>
        <div id="messages-container"></div>
        <input type="text" id="message-input" placeholder="Message">
        <button id="send-button">Post Message</button>
    </div>
</body>

</html>